define(function(require){function t(t,e){return i.map(i.range(t,e+1),function(t){var i=t>9?t:"0"+t;return[i,t]})}var i=require("underscore"),$=require("$"),e=require("events"),n=require("moment"),a=require("modal"),s=require("./scroll-picker"),h=require("./date-picker.html"),d=1900,r=2030,o=function(){i.bindAll(this),e.mixTo(this),this.$el=$(h).appendTo("body"),this.modal=new a(this.$el),this.init()};return o.prototype={constructor:o,init:function(){this.yearPicker=new s(this.$el.find(".date")[0],{data:t(d,r)}),this.monthPicker=new s(this.$el.find(".date")[1],{data:t(1,12)}),this.dayPicker=new s(this.$el.find(".date")[2]),this.yearPicker.on("picked",this.handleYearMonthPick),this.monthPicker.on("picked",this.handleYearMonthPick),this.dayPicker.on("picked",this.handleDayPick),this.$el.find(".cancel").tap(this.hide),this.$el.find(".submit").tap(this.submit)},show:function(t){this.modal.show(),t=t||{};var e=t.date||n();i.isString(e)&&(e=n(e)),this.yearPicker.gotoIndex(e.year()-d),this.monthPicker.gotoIndex(e.month()-0),this.dayPicker.gotoIndex(e.date()-1)},hide:function(){this.modal.hide()},submit:function(){this.hide(),this.trigger("submit",this.date)},handleYearMonthPick:function(){if(this.yearPicker.value&&this.monthPicker.value){var i=n([this.yearPicker.value,this.monthPicker.value-1]).daysInMonth(),e=this.dayPicker.getIndex();this.dayPicker.render({data:t(1,i)}),this.dayPicker.gotoIndex(e||0)}},handleDayPick:function(){this.date=n([this.yearPicker.value,this.monthPicker.value-1,this.dayPicker.value]),this.$el.find(".date-title").text(this.date.format("YYYY-MM-DD ddd")),this.renderFestival()},renderFestival:function(){n().startOf("day").isSame(this.date)?this.$el.find(".date-descr").text("今天"):this.$el.find(".date-descr").text("")}},o.create=function(t){o.instance||(o.instance=new o,o.instance.on("submit",function(t){$(o.relatedInput).val(t.format("YYYY-MM-DD")).attr("formnovalidate",!1).trigger("change")})),$(t).focus(function(){if(!this.readOnly&&!this.disabled){$(this).attr("formnovalidate",!0),this.blur(),this.disabled=!0;var t=this;setTimeout(function(){t.disabled=!1},1),o.instance.show({date:this.value}),o.relatedInput=this}})},n.lang("zh",{weekdaysShort:"周日 周一 周二 周三 周四 周五 周六".split(" ")}),o});