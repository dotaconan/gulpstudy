define(function(require,t,e){var i=require("underscore"),$=require("$"),s=require("./touch-validator-util"),r=require("./touch-validator-methods"),n=function(t,e){i.bindAll(this),this.$form=$(t),this.settings=i.extend({},n.defaults,e),this.storeRules(),this.init()};return i.extend(n.prototype,{storeRules:function(){this.rules=this.settings.rules||{},i.each(this.rules,function(t,e){this.rules[e]=s.normalizeRule(t)},this)},init:function(){this.valueCache={},this.pendingRequest=0,this.ajaxRequests={},this.pending={},this.reset(),this.$form.on("focusin focusout",'[type="text"], [type="password"], [type="file"], select, textarea, [type="number"], [type="search"] ,[type="tel"], [type="url"], [type="email"], [type="datetime"], [type="date"], [type="month"], [type="week"], [type="time"], [type="datetime-local"], [type="range"], [type="color"] ',this.handleFieldEvent),this.$form.on("click",'[type="radio"], [type="checkbox"], select, option',this.handleFieldEvent),this.$form.prop("noValidate",!0).on("submit",this.handleSubmit)},handleFieldEvent:function(t){var e="on"+t.type;this.settings[e]&&this.settings[e].call(this,t.target,t)},handleSubmit:function(t){return this.validateForm()?this.pendingRequest>0?(this.formNeedSubmit=!0,!1):this.settings.submitHandler?(this.settings.submitHandler.call(this,this.$form[0],t),!1):void 0:!1},validateForm:function(){var t=this.checkForm();return this.errors().hide(),t||this.showErrors(),t},validateElement:function(t){if($(t).is(this.settings.ignore))return!0;t=this.validationTargetFor(t),this.reset();var e=this.check(t);return e?(this.errorsFor(t).hide(),$(t).parents(".item").removeClass("highlight")):this.showErrors(),e},check:function(t){t=this.validationTargetFor(t);var e=this.rulesFor(t),i=$(t).val();for(var s in e){var r={method:s,parameters:e[s]};try{var h=n.methods[s].call(this,i,t,r.parameters);if("pending"===h)return!0;if(!h)return this.addError(t,r),!1}catch(o){throw this.settings.debug&&window.console&&console.log("exception occured when checking element "+t.id+", check the '"+r.method+"' method",o),o}}return!0},checkForm:function(){return this.reset(),i.each(this.allElements(),function(t){this.check(t)},this),0===this.errorList.length},showErrors:function(t){if(this.settings.highlight&&i.each(this.errorList,function(t){this.settings.highlight.call(this,t.element)},this),this.settings.unhighlight){var e=i(this.errorList).map(function(t){return t.element});i(this.allElements().not(e)).each(function(t){this.settings.unhighlight.call(this,t)},this)}this.settings.showErrors.call(this)},addError:function(t,e){var i=this.messageFor(t,e);this.errorList.push({message:i,element:t}),this.errorMap[t.name]=i},messageFor:function(t,e){var i=this.settings.messages[t.name];"object"==typeof i&&(i=i[e.method]),i||(i=n.methodMessages[e.method]||"缺少错误提示");var s=/\$?\{(\d+)\}/g;return"function"==typeof i?i=i.call(this,e.parameters,t):s.test(i)&&(i=n.formatMessage(i.replace(s,"{$1}"),e.parameters)),i},allElements:function(){var t={},e=this,s=this.$form.find("input, select, textarea").not('[type="submit"], [type="reset"], [type="image"], [disabled]').not(this.settings.ignore).filter(function(){return this.name in t||i.isEmpty(e.rulesFor(this))?!1:(t[this.name]=!0,!0)});return s},rulesFor:function(t){var e=i.extend({},this.rules[t.name]);if(e.required){var s=e.required;delete e.required,e=$.extend({required:s},e)}return e},validationTargetFor:function(t){return s.checkable(t)&&(t=s.findByName(t).not(this.settings.ignore)[0]),t},reset:function(){this.errorList=[],this.errorMap={},this.currentElements=$([])},errorsFor:function(t){var e=this.idOrName(t);return this.errors().filter('[for="'+e+'"]')},idOrName:function(t){return s.checkable(t)?t.name:t.id||t.name},errors:function(){var t=this.settings.errorClass.replace(" ",".");return $(this.settings.errorElement+"."+t,this.$form)},showErrorLabel:function(t,e){var i=this.errorsFor(t);i.length>0?i.html(e||"").show():(i=$("<"+this.settings.errorElement+"/>").attr("for",this.idOrName(t)).addClass(this.settings.errorClass).html(e||""),this.settings.errorPlacement?this.settings.errorPlacement.call(this,i,$(t)):i.insertAfter(t))},startRequest:function(t){this.pending[t.name]||(this.pendingRequest++,this.pending[t.name]=!0)},stopRequest:function(t,e){this.pendingRequest--,this.pendingRequest<0&&(this.pendingRequest=0),delete this.pending[t.name],e&&0===this.pendingRequest&&this.formNeedSubmit&&this.checkForm()?(this.$form.submit(),this.formNeedSubmit=!1):!e&&0===this.pendingRequest&&this.formNeedSubmit&&(this.formNeedSubmit=!1)},previousValue:function(t){var e=$(t).data("previousValue");if(!e){var i={old:null,valid:!0};$(t).data("previousValue",JSON.stringify(i))}return e?JSON.parse(e):i}}),i.extend(n,{defaults:{errorClass:"error",errorElement:"label",ignore:"null",messages:{},highlight:function(t){$(t).parents(".item").addClass("highlight")},unhighlight:!1,errorPlacement:function(t,e){e.parents(".item").after(t)},onfocusout:function(t,e){s.checkable(t)||this.validateElement(t)},showErrors:function(){i.each(this.errorList,function(t){this.showErrorLabel(t.element,t.message)},this)}},addMethod:function(t,e,i){n.methods[t]=e,n.methodMessages[t]=i},setDefaults:function(t){i.extend(this.defaults,t)}},r,s),n});